/*! For license information please see 68eb404b20789ad009ac.js.LICENSE.txt */
function _regenerator(){var e,t,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",a=n.toStringTag||"@@toStringTag";function r(n,o,a,r){var c=o&&o.prototype instanceof s?o:s,l=Object.create(c.prototype);return _regeneratorDefine2(l,"_invoke",function(n,o,a){var r,s,c,l=0,u=a||[],d=!1,g={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return r=t,s=0,c=e,g.n=n,i}};function p(n,o){for(s=n,c=o,t=0;!d&&l&&!a&&t<u.length;t++){var a,r=u[t],p=g.p,m=r[2];n>3?(a=m===o)&&(c=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=e):r[0]<=p&&((a=n<2&&p<r[1])?(s=0,g.v=o,g.n=r[1]):p<m&&(a=n<3||r[0]>o||o>m)&&(r[4]=n,r[5]=o,g.n=m,s=0))}if(a||n>1)return i;throw d=!0,o}return function(a,u,m){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&p(u,m),s=u,c=m;(t=s<2?e:c)||!d;){r||(s?s<3?(s>1&&(g.n=-1),p(s,c)):g.n=c:g.v=c);try{if(l=2,r){if(s||(a="next"),t=r[a]){if(!(t=t.call(r,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,s<2&&(s=0)}else 1===s&&(t=r.return)&&t.call(r),s<2&&(c=TypeError("The iterator does not provide a '"+a+"' method"),s=1);r=e}else if((t=(d=g.n<0)?c:n.call(o,g))!==i)break}catch(t){r=e,s=1,c=t}finally{l=1}}return{value:t,done:d}}}(n,a,r),!0),l}var i={};function s(){}function c(){}function l(){}t=Object.getPrototypeOf;var u=[][o]?t(t([][o]())):(_regeneratorDefine2(t={},o,function(){return this}),t),d=l.prototype=s.prototype=Object.create(u);function g(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,_regeneratorDefine2(e,a,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=l,_regeneratorDefine2(d,"constructor",l),_regeneratorDefine2(l,"constructor",c),c.displayName="GeneratorFunction",_regeneratorDefine2(l,a,"GeneratorFunction"),_regeneratorDefine2(d),_regeneratorDefine2(d,a,"Generator"),_regeneratorDefine2(d,o,function(){return this}),_regeneratorDefine2(d,"toString",function(){return"[object Generator]"}),(_regenerator=function(){return{w:r,m:g}})()}function _regeneratorDefine2(e,t,n,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}_regeneratorDefine2=function(e,t,n,o){if(t)a?a(e,t,{value:n,enumerable:!o,configurable:!o,writable:!o}):e[t]=n;else{var r=function(t,n){_regeneratorDefine2(e,t,function(e){return this._invoke(t,n,e)})};r("next",0),r("throw",1),r("return",2)}},_regeneratorDefine2(e,t,n,o)}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function asyncGeneratorStep(e,t,n,o,a,r,i){try{var s=e[r](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(o,a)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(o,a){var r=e.apply(t,n);function i(e){asyncGeneratorStep(r,o,a,i,s,"next",e)}function s(e){asyncGeneratorStep(r,o,a,i,s,"throw",e)}i(void 0)})}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,o)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}Office.onReady(function(e){e.host!==Office.HostType.Word&&e.host!==Office.HostType.Excel&&e.host!==Office.HostType.PowerPoint||initializeApp()});var toastTimeout,AI_ASSISTANT_NAME="星尘AI",AI_AVATAR_CHAR="✨",EMOJIS=["😀","😂","😊","😍","🤔","👍","🎉","❤️","🚀","💡","💯","🙏","👋","🔥","👀","🌟","💻","🤖","✨","🥳","🤯","🙌","🤞","🧠","🧑‍💻","🌌","🌠","🛰️","👽"],MAX_MESSAGES_DISPLAY=60,MAX_HISTORY_SENT_TO_API=12,STORAGE_KEY_MESSAGES="aiStardustChatMessages_v4_1_office",STORAGE_KEY_CONFIG="aiStardustChatApiConfig_v4_1_office",STORAGE_KEY_THEME="aiStardustChatTheme_v4_1_office",appContainer=document.getElementById("appContainer"),chatPage=document.getElementById("chatPage"),settingsPage=document.getElementById("settingsPage"),messageArea=document.getElementById("messageArea"),messageInput=document.getElementById("messageInput"),sendButton=document.getElementById("sendButton"),userList=document.getElementById("userList"),usernameHeader=document.getElementById("usernameHeader"),userAvatarHeader=document.getElementById("userAvatarHeader"),themeToggleButton=document.getElementById("themeToggleButton"),themeToggleIcon=themeToggleButton.querySelector("i"),settingsButton=document.getElementById("settingsButton"),profileButton=document.getElementById("profileButton"),emojiButton=document.getElementById("emojiButton"),emojiPicker=document.getElementById("emojiPicker"),typingIndicator=document.getElementById("typingIndicator"),stopGeneratingButton=document.getElementById("stopGeneratingButton"),closeSettingsButton=document.getElementById("closeSettingsButton"),settingsUsernameInput=document.getElementById("settingsUsernameInput"),darkModeToggle=document.getElementById("darkModeToggle"),clearChatButton=document.getElementById("clearChatButton"),clearContextButton=document.getElementById("clearContextButton"),apiSettingsForm=document.getElementById("apiSettingsForm"),settingsStatusIndicator=document.getElementById("settingsStatusIndicator"),apiProviderRadios=document.querySelectorAll('input[name="apiProvider"]'),settingsApiKeyInput=document.getElementById("settingsApiKey"),settingsApiUrlGroup=document.getElementById("settingsApiUrlGroup"),settingsApiUrlInput=document.getElementById("settingsApiUrl"),settingsDefaultApiUrls=document.getElementById("settingsDefaultApiUrls"),settingsDeepseekUrl=document.getElementById("settingsDeepseekUrl"),settingsOpenaiUrl=document.getElementById("settingsOpenaiUrl"),settingsGeminiUrl=document.getElementById("settingsGeminiUrl"),settingsModelListInput=document.getElementById("settingsModelList"),settingsModelSelect=document.getElementById("settingsModelSelect"),fetchModelsButton=document.getElementById("fetchModelsButton"),settingsStreamingEnabled=document.getElementById("settingsStreamingEnabled"),settingsReasoningEnabled=document.getElementById("settingsReasoningEnabled"),reasoningOptionContainer=document.getElementById("reasoningOptionContainer"),aiStyleSelect=document.getElementById("aiStyleSelect"),aiStyleStrength=document.getElementById("aiStyleStrength"),saveSettingsButton=document.getElementById("saveSettingsButton"),customApiSettingsSection=document.getElementById("customApiSettingsSection"),customBodyKeyInput=document.getElementById("customBodyKey"),customBodyValueInput=document.getElementById("customBodyValue"),addCustomBodyParamButton=document.getElementById("addCustomBodyParamButton"),customBodyParamsList=document.getElementById("customBodyParamsList"),toastNotification=document.getElementById("toastNotification"),getSelectionButton=document.getElementById("getSelectionButton"),currentUsername="Office User",currentUserAvatarChar="O",currentConversationHistory=[],apiConfig={provider:"gemini",apiKey:"",apiUrl:"https://generativelanguage.googleapis.com/v1beta/models/",models:[],defaultModel:"",streaming:!0,reasoning:!1,aiStyle:"default",aiStyleStrength:1,customBodyParams:[]},abortController=null,isEmojiPickerOpen=!1,lastMessageElement=null,conversationContextId=Date.now().toString();function getAvatarUrl(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"36x36",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"82a9ff",o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"0d0f1a",a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"orbitron";if(/(?:[#\*0-9\xA9\xAE\u203C\u2049\u2122\u2139\u2194-\u2199\u21A9\u21AA\u231A\u231B\u2328\u23CF\u23E9-\u23F3\u23F8-\u23FA\u24C2\u25AA\u25AB\u25B6\u25C0\u25FB-\u25FE\u2600-\u2604\u260E\u2611\u2614\u2615\u2618\u261D\u2620\u2622\u2623\u2626\u262A\u262E\u262F\u2638-\u263A\u2640\u2642\u2648-\u2653\u265F\u2660\u2663\u2665\u2666\u2668\u267B\u267E\u267F\u2692-\u2697\u2699\u269B\u269C\u26A0\u26A1\u26A7\u26AA\u26AB\u26B0\u26B1\u26BD\u26BE\u26C4\u26C5\u26C8\u26CE\u26CF\u26D1\u26D3\u26D4\u26E9\u26EA\u26F0-\u26F5\u26F7-\u26FA\u26FD\u2702\u2705\u2708-\u270D\u270F\u2712\u2714\u2716\u271D\u2721\u2728\u2733\u2734\u2744\u2747\u274C\u274E\u2753-\u2755\u2757\u2763\u2764\u2795-\u2797\u27A1\u27B0\u27BF\u2934\u2935\u2B05-\u2B07\u2B1B\u2B1C\u2B50\u2B55\u3030\u303D\u3297\u3299]|\uD83C[\uDC04\uDCCF\uDD70\uDD71\uDD7E\uDD7F\uDD8E\uDD91-\uDD9A\uDDE6-\uDDFF\uDE01\uDE02\uDE1A\uDE2F\uDE32-\uDE3A\uDE50\uDE51\uDF00-\uDF21\uDF24-\uDF93\uDF96\uDF97\uDF99-\uDF9B\uDF9E-\uDFF0\uDFF3-\uDFF5\uDFF7-\uDFFF]|\uD83D[\uDC00-\uDCFD\uDCFF-\uDD3D\uDD49-\uDD4E\uDD50-\uDD67\uDD6F\uDD70\uDD73-\uDD7A\uDD87\uDD8A-\uDD8D\uDD90\uDD95\uDD96\uDDA4\uDDA5\uDDA8\uDDB1\uDDB2\uDDBC\uDDC2-\uDDC4\uDDD1-\uDDD3\uDDDC-\uDDDE\uDDE1\uDDE3\uDDE8\uDDEF\uDDF3\uDDFA-\uDE4F\uDE80-\uDEC5\uDECB-\uDED2\uDED5-\uDED7\uDEDC-\uDEE5\uDEE9\uDEEB\uDEEC\uDEF0\uDEF3-\uDEFC\uDFE0-\uDFEB\uDFF0]|\uD83E[\uDD0C-\uDD3A\uDD3C-\uDD45\uDD47-\uDDFF\uDE70-\uDE7C\uDE80-\uDE89\uDE8F-\uDEC6\uDECE-\uDEDC\uDEDF-\uDEE9\uDEF0-\uDEF8])/.test(e)){var r=document.createElement("canvas"),i=r.getContext("2d"),s=window.devicePixelRatio||1,c=parseInt(t.split("x")[0])*s;return r.width=c,r.height=c,i.fillStyle="#".concat(n),i.fillRect(0,0,c,c),i.textAlign="center",i.textBaseline="middle",i.font="".concat(.65*c,"px sans-serif"),i.fillText(e,c/2,c/2+.08*c),r.toDataURL()}return"https://placehold.co/".concat(t,"/").concat(n,"/").concat(o,"?text=").concat(encodeURIComponent(e.toUpperCase()),"&font=").concat(a)}function getCurrentTime(){return(new Date).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",hour12:!1})}function scrollToBottom(){setTimeout(function(){messageArea.scrollTo({top:messageArea.scrollHeight,behavior:"smooth"})},50)}function showToast(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3500;toastTimeout&&clearTimeout(toastTimeout);var o="fa-info-circle";"success"===t?o="fa-check-circle":"error"===t?o="fa-times-circle":"warning"===t&&(o="fa-exclamation-triangle"),toastNotification.innerHTML='<i class="fas '.concat(o,' mr-3 text-xl"></i> <div class="flex-1">').concat(e,"</div>"),toastNotification.className="fixed bottom-6 right-6 z-[200] transition-all duration-300 px-5 py-4 rounded-xl shadow-xl text-sm font-medium flex items-start min-w-[300px] max-w-md",toastNotification.classList.remove("opacity-0","translate-y-5","scale-95","success","error","warning","info"),"success"===t?(toastNotification.style.backgroundColor="var(--success-color)",toastNotification.style.color="white"):"error"===t?(toastNotification.style.backgroundColor="var(--error-color)",toastNotification.style.color="white"):"warning"===t?(toastNotification.style.backgroundColor="var(--warning-color)",toastNotification.style.color=document.documentElement.classList.contains("light")?"#573a00":"#fef3c7"):(toastNotification.style.backgroundColor="var(--text-accent)",toastNotification.style.color="white"),requestAnimationFrame(function(){toastNotification.style.opacity="1",toastNotification.style.transform="translateY(0) scale(1)"}),toastTimeout=setTimeout(function(){toastNotification.style.opacity="0",toastNotification.style.transform="translateY(5px) scale(0.95)"},n)}function navigateTo(e){document.querySelectorAll(".page").forEach(function(t){t.id===e?t.classList.contains("hidden")&&(t.classList.remove("hidden"),t.classList.add("entering"),requestAnimationFrame(function(){return requestAnimationFrame(function(){return t.classList.remove("entering")})})):t.classList.contains("hidden")||t.classList.add("hidden")}),"chatPage"!==e&&isEmojiPickerOpen&&toggleEmojiPicker(!1),"settingsPage"===e&&loadSettingsToUI()}function applyTheme(e){var t=document.documentElement;e?(t.classList.add("light"),themeToggleIcon.classList.remove("fa-moon"),themeToggleIcon.classList.add("fa-sun"),darkModeToggle&&(darkModeToggle.checked=!0)):(t.classList.remove("light"),themeToggleIcon.classList.remove("fa-sun"),themeToggleIcon.classList.add("fa-moon"),darkModeToggle&&(darkModeToggle.checked=!1)),userAvatarHeader.src=getAvatarUrl(currentUserAvatarChar,"36x36",e?"3b82f6":"82a9ff",e?"ffffff":"0d0f1a"),renderUserList(),setTimeout(function(){return Prism.highlightAll()},50)}function toggleTheme(){var e=document.documentElement.classList.toggle("light");applyTheme(e),localStorage.setItem(STORAGE_KEY_THEME,e?"light":"dark")}function loadConfig(){var e=localStorage.getItem(STORAGE_KEY_CONFIG);if(e)try{var t=JSON.parse(e);apiConfig=_objectSpread(_objectSpread({},apiConfig),t),Array.isArray(apiConfig.models)||(apiConfig.models=[]),Array.isArray(apiConfig.customBodyParams)||(apiConfig.customBodyParams=[])}catch(e){console.error("Failed to parse saved API config:",e),showToast("无法加载API配置，使用默认设置。","error"),localStorage.removeItem(STORAGE_KEY_CONFIG)}"custom"!==apiConfig.provider?updateApiUrlForProvider(apiConfig.provider,!1):"custom"!==apiConfig.provider||apiConfig.apiUrl||(apiConfig.apiUrl="");var n,o=settingsUsernameInput.value.trim();o&&(currentUserAvatarChar=(null===(n=(currentUsername=o).charAt(0))||void 0===n?void 0:n.toUpperCase())||"O",usernameHeader.textContent=currentUsername),updateModelSelectDropdown(),renderCustomBodyParamsList()}function updateApiUrlForProvider(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];switch(e){case"deepseek":apiConfig.apiUrl="https://api.deepseek.com/v1";break;case"openai":apiConfig.apiUrl="https://api.openai.com/v1";break;case"gemini":default:apiConfig.apiUrl="https://generativelanguage.googleapis.com/v1beta/models/";case"custom":}settingsApiUrlInput&&"custom"!==e&&(settingsApiUrlInput.value=apiConfig.apiUrl),t&&saveConfig()}function saveConfig(){try{return localStorage.setItem(STORAGE_KEY_CONFIG,JSON.stringify(apiConfig)),!0}catch(e){return console.error("Failed to save API config:",e),showToast("保存API配置失败！","error"),!1}}function loadSettingsToUI(){settingsUsernameInput.value=currentUsername;var e=document.querySelector('input[name="apiProvider"][value="'.concat(apiConfig.provider,'"]'));e&&(e.checked=!0),settingsApiKeyInput.value=apiConfig.apiKey,settingsApiUrlInput.value=apiConfig.apiUrl,settingsModelListInput.value=apiConfig.models.join(","),settingsStreamingEnabled.checked=apiConfig.streaming,settingsReasoningEnabled.checked=apiConfig.reasoning,aiStyleSelect.value=apiConfig.aiStyle,aiStyleStrength.value=apiConfig.aiStyleStrength,updateApiUrlVisibility(),updateModelSelectDropdown(),renderCustomBodyParamsList()}function updateApiUrlVisibility(){var e,t=(null===(e=document.querySelector('input[name="apiProvider"]:checked'))||void 0===e?void 0:e.value)||apiConfig.provider;settingsApiUrlGroup.style.display="custom"===t?"block":"none",customApiSettingsSection.style.display="custom"===t?"block":"none",settingsDefaultApiUrls.style.display="custom"!==t?"block":"none","custom"!==t&&(settingsDeepseekUrl.style.display="deepseek"===t?"block":"none",settingsOpenaiUrl.style.display="openai"===t?"block":"none",settingsGeminiUrl.style.display="gemini"===t?"block":"none"),reasoningOptionContainer.style.display="deepseek"===t?"block":"none","deepseek"!==t&&(settingsReasoningEnabled.checked=!1)}function updateModelSelectDropdown(){if(settingsModelSelect.innerHTML="",apiConfig.models&&apiConfig.models.length>0)apiConfig.models.forEach(function(e){var t=document.createElement("option");t.value=e,t.textContent=e,settingsModelSelect.appendChild(t)}),settingsModelSelect.value=apiConfig.defaultModel||apiConfig.models[0];else{var e=document.createElement("option");e.value="",e.textContent="-- 无可用模型 --",settingsModelSelect.appendChild(e)}}function showSettingsStatus(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",n="fa-info-circle";"success"===t?n="fa-check-circle":"error"===t?n="fa-times-circle":"warning"===t&&(n="fa-exclamation-triangle"),settingsStatusIndicator.innerHTML='<i class="fas '.concat(n,' mr-2.5 text-lg"></i> ').concat(e),settingsStatusIndicator.className="status-indicator fixed top-5 right-5 z-[100] glassmorphism !p-3 !rounded-xl flex items-center",settingsStatusIndicator.style.color="success"===t?"var(--success-color)":"error"===t?"var(--error-color)":"warning"===t?"var(--warning-color)":"var(--text-accent)",settingsStatusIndicator.style.display="flex",setTimeout(function(){settingsStatusIndicator.style.display="none"},4e3)}function configureMarkdown(){marked.setOptions({breaks:!1,gfm:!0,highlight:function(e,t){var n=t||"plaintext";return Prism.languages[n]?Prism.highlight(e,Prism.languages[n],n):e}});var e=new marked.Renderer;e.code=function(e,t,n){var o=(t||"").match(/\S*/)[0],a=this.options.highlight(e,o),r=o?"".concat(this.options.langPrefix).concat(o):"".concat(this.options.langPrefix,"plaintext");return'<pre class="'.concat(r,'" data-lang="').concat(o||"plaintext",'"><code class="').concat(r,'">').concat(a,"\n</code></pre>\n")};var t=e.paragraph.bind(e);e.paragraph=function(e){return e=(e=e.replace(/\$(.+?)\$/g,function(e,t){try{return katex.renderToString(t,{throwOnError:!1,displayMode:!1})}catch(t){return'<span class="katex-error" title="'.concat(t.message,'">').concat(e,"</span>")}})).replace(/\$\$([\s\S]+?)\$\$/g,function(e,t){try{return katex.renderToString(t.trim(),{throwOnError:!1,displayMode:!0})}catch(e){return'<div class="katex-error" title="'.concat(e.message,'"><pre>').concat(t.trim(),"</pre></div>")}}),t(e)},marked.use({renderer:e})}function highlightCodeInElement(e){"undefined"!=typeof Prism&&(Prism.highlightAllUnder(e||document.body),addOfficeActionButtons(e||document.body))}function renderMessageContent(e){var t=marked.parse(e);return DOMPurify.sanitize(t,{USE_PROFILES:{html:!0},ADD_TAGS:["math","annotation","semantics","mtext","mn","mo","mi","mspace","mover","munder","munderover","mstyle","mfrac","msqrt","mroot","mtable","mtr","mtd","mlabeledtr"],ADD_ATTR:["encoding","xmlns","class","style","aria-hidden","title","start","data-lang"]})}function displayMessage(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"?",a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(t||n||r||a){var i=a||"msg-".concat(Date.now(),"-").concat(Math.random().toString(16).slice(2)),s=document.getElementById(i);if(s&&!n){var c=s.querySelector(".message-bubble"),l=c.querySelector(".message-text");if(l&&(l.innerHTML=renderMessageContent(t||""),highlightCodeInElement(l)),"deepseek"===apiConfig.provider&&apiConfig.reasoning&&null!==r){var u=c.querySelector(".reasoning-content");!u&&r&&((u=document.createElement("div")).className="reasoning-content",c.insertBefore(u,l)),u&&(u.textContent=r)}return lastMessageElement=s,scrollToBottom(),s}var d=document.createElement("div");d.id=i,d.classList.add("flex","items-start","max-w-full","group","mb-1.5","py-2");var g=document.documentElement.classList.contains("light"),p=n?g?"3b82f6":"6a82fb":e===AI_ASSISTANT_NAME?g?"10b981":"2dd4bf":"a0a8c0",m=n?g?"ffffff":"e0e7ff":e===AI_ASSISTANT_NAME?g?"ffffff":"0d0f1a":"1a1c2d",f=document.createElement("img");f.src=getAvatarUrl(o,"36x36",p,m),f.alt="".concat(e," avatar"),f.classList.add("w-9","h-9","rounded-full","flex-shrink-0","shadow-md","border-2","border-[var(--bg-secondary)]");var y=document.createElement("div");y.className="flex flex-col mx-2.5 flex-grow min-w-0";var v=document.createElement("div");v.classList.add("message-bubble","relative"),v.classList.add(n?"my-message":"other-message");var h=document.createElement("div");if(h.classList.add("message-text","break-words"),h.innerHTML=e!==AI_ASSISTANT_NAME||t?renderMessageContent(t||""):"",v.appendChild(h),"deepseek"===apiConfig.provider&&apiConfig.reasoning&&r&&!n){var C=document.createElement("div");C.className="reasoning-content",C.textContent=r,v.appendChild(C)}if(y.appendChild(v),!n&&t){var A=document.createElement("div");A.className="message-actions mt-1.5";var S=document.createElement("button");S.className="message-action-btn",S.innerHTML='<i class="fas fa-file-download mr-1"></i> 插入全文',S.onclick=function(){return insertContent(h.innerText)},A.appendChild(S),y.appendChild(A)}for(n?(d.classList.add("justify-end"),y.classList.add("items-end"),d.appendChild(y),d.appendChild(f)):(d.classList.add("justify-start"),y.classList.add("items-start"),d.appendChild(f),d.appendChild(y)),messageArea.appendChild(d);messageArea.children.length>MAX_MESSAGES_DISPLAY+1;){var E;if(null!==(E=messageArea.firstElementChild)&&void 0!==E&&E.querySelector(".text-xs.px-2")){if(!(messageArea.children.length>2))break;messageArea.removeChild(messageArea.children[1])}else messageArea.removeChild(messageArea.firstElementChild)}return t&&highlightCodeInElement(v),(t||n)&&scrollToBottom(),n||(lastMessageElement=d),d}}function sendMessage(){var e=messageInput.value.trim();if(e)if(abortController)showToast("AI 正在回复，请稍候...","warning");else{var t="请在回复时遵循以下规则：如果你需要提供Excel公式，必须使用Markdown的代码框格式，并标记语言为 `formula`，例如：```formula\n=SUM(A1:A10)\n```。对于其他代码，也请使用对应的语言标记。";if("default"!==apiConfig.aiStyle){switch(apiConfig.aiStyle){case"professional":t+=" 请用专业、严谨的语气回答。";break;case"friendly":t+=" 请用友好、亲切的语气回答。";break;case"humorous":t+=" 请用幽默、风趣的语气回答。";break;case"concise":t+=" 请用简洁、直接的方式回答。";break;case"detailed":t+=" 请提供详细、全面的回答。"}apiConfig.aiStyleStrength>1.1?t+=" (风格强度: ".concat(apiConfig.aiStyleStrength,", 请更强调此风格)"):apiConfig.aiStyleStrength<.9&&(t+=" (风格强度: ".concat(apiConfig.aiStyleStrength,", 请柔和表达此风格)"))}var n=[];if("openai"===apiConfig.provider||"deepseek"===apiConfig.provider||"custom"===apiConfig.provider)t&&n.push({role:"system",content:t}),(n=[].concat(_toConsumableArray(n),_toConsumableArray(currentConversationHistory.slice(-MAX_HISTORY_SENT_TO_API).map(function(e){return{role:e.role,content:e.content}})))).push({role:"user",content:e});else if("gemini"===apiConfig.provider){var o=e;currentConversationHistory.slice(-MAX_HISTORY_SENT_TO_API).forEach(function(e){n.push({role:"assistant"===e.role?"model":"user",parts:[{text:e.content}]})}),t&&0===n.length&&(o=t+"\n\n"+e),n.push({role:"user",parts:[{text:o}]})}if(displayMessage(currentUsername,e,!0,currentUserAvatarChar),currentConversationHistory.push({role:"user",content:e,contextId:conversationContextId}),saveConversationToStorage(),messageInput.value="",messageInput.style.height="auto",messageInput.focus(),sendButton.disabled=!0,isEmojiPickerOpen&&toggleEmojiPicker(!1),apiConfig.apiKey&&apiConfig.apiUrl)if(apiConfig.defaultModel){var a="msg-ai-".concat(Date.now());displayMessage(AI_ASSISTANT_NAME,"",!1,AI_AVATAR_CHAR,null,a),showTypingIndicator(),stopGeneratingButton.style.display="inline-flex",abortController=new AbortController,callChatAPI(apiConfig.defaultModel,n,apiConfig.streaming,a,function(e,t,n){if(t){hideTypingIndicator(),stopGeneratingButton.style.display="none",abortController=null;var o=document.getElementById(a);if(o){var r,i=(null===(r=o.querySelector(".message-text"))||void 0===r?void 0:r.innerText)||"[空响应]",s=currentConversationHistory.filter(function(e){return"assistant"===e.role}).pop();for(s&&s.content===i||(currentConversationHistory.push({role:"assistant",content:i,contextId:conversationContextId}),saveConversationToStorage());currentConversationHistory.length>2*MAX_MESSAGES_DISPLAY;)currentConversationHistory.shift()}}})}else displayMessage(AI_ASSISTANT_NAME,"错误：未选择默认模型。请在设置中选择。",!1,AI_AVATAR_CHAR);else displayMessage(AI_ASSISTANT_NAME,"错误：API 密钥或地址未配置。请在设置中配置。",!1,AI_AVATAR_CHAR)}}function callChatAPI(e,t,n,o,a){return _callChatAPI.apply(this,arguments)}function _callChatAPI(){return(_callChatAPI=_asyncToGenerator(_regenerator().m(function e(t,n,o,a,r){var i,s,c,l,u,d,g,p,m,f,y,v,h,C,A,S,E,I,b,D,T,x,B,_,k,M,w,P,O,L,F,U;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return i=apiConfig.apiUrl.replace(/\/$/,""),s={"Content-Type":"application/json"},"gemini"!==apiConfig.provider&&(s.Authorization="Bearer ".concat(apiConfig.apiKey)),c={},l=t,"gemini"===apiConfig.provider?(i+="/".concat(l,":streamGenerateContent?key=").concat(apiConfig.apiKey,"&alt=sse"),c={contents:n}):(i+="/chat/completions",l="deepseek"===apiConfig.provider&&apiConfig.reasoning?"deepseek-reasoner":t,c={model:l,messages:n,stream:o}),"custom"===apiConfig.provider&&Array.isArray(apiConfig.customBodyParams)&&apiConfig.customBodyParams.forEach(function(e){try{c[e.key]=JSON.parse(e.value)}catch(t){c[e.key]=e.value}}),u=JSON.stringify(c),e.p=1,e.n=2,fetch(i,{method:"POST",headers:s,body:u,signal:null===(d=abortController)||void 0===d?void 0:d.signal});case 2:if((g=e.v).ok){e.n=7;break}return e.p=3,e.n=4,g.json();case 4:m=e.v,e.n=6;break;case 5:e.p=5,e.v,m={error:{message:g.statusText}};case 6:return f=(null===(p=m.error)||void 0===p?void 0:p.message)||m.message||g.statusText,y="API Error (".concat(g.status,"): ").concat(f),console.error(y,m),displayMessage(AI_ASSISTANT_NAME,"抱歉，请求出错：".concat(y),!1,AI_AVATAR_CHAR,null,a),r(null,!0,null),e.a(2);case 7:if(!o&&"gemini"!==apiConfig.provider||!g.body){e.n=16;break}v=g.body.getReader(),h=new TextDecoder,C="",A="",S="";case 8:return e.n=9,v.read();case 9:if(E=e.v,I=E.done,b=E.value,!I){e.n=10;break}return e.a(3,15);case 10:C+=h.decode(b,{stream:!0}),D=void 0;case 11:if(!((D=C.indexOf("\n"))>=0)){e.n=14;break}if(T=C.substring(0,D).trim(),C=C.substring(D+1),!T.startsWith("data:")){e.n=13;break}if("[DONE]"!==(x=T.substring(5).trim())||"gemini"===apiConfig.provider){e.n=12;break}return v.cancel(),r(A,!0,S),e.a(2);case 12:try{B=JSON.parse(x),_="",k=null,"gemini"===apiConfig.provider?B.candidates&&B.candidates[0].content&&B.candidates[0].content.parts&&B.candidates[0].content.parts[0].text&&(_=B.candidates[0].content.parts[0].text):B.choices&&B.choices[0].delta&&(B.choices[0].delta.content&&(_=B.choices[0].delta.content),"deepseek"===apiConfig.provider&&apiConfig.reasoning&&B.choices[0].delta.reasoning_content&&(k=B.choices[0].delta.reasoning_content)),_&&(A+=_),k&&(S+=k),displayMessage(AI_ASSISTANT_NAME,A,!1,AI_AVATAR_CHAR,null,a,"deepseek"===apiConfig.provider?S:null)}catch(e){console.warn("Failed to parse stream data line:",x,e)}case 13:e.n=11;break;case 14:e.n=8;break;case 15:r(A,!0,"deepseek"===apiConfig.provider?S:null),e.n=18;break;case 16:return e.n=17,g.json();case 17:M=e.v,w="",P=null,"gemini"===apiConfig.provider?M.candidates&&M.candidates[0].content&&M.candidates[0].content.parts&&M.candidates[0].content.parts[0].text?w=M.candidates[0].content.parts[0].text:M.promptFeedback&&M.promptFeedback.blockReason&&(w="请求被阻止: ".concat(M.promptFeedback.blockReason),M.promptFeedback.blockReasonMessage&&(w+=" - ".concat(M.promptFeedback.blockReasonMessage))):M.choices&&M.choices[0].message&&M.choices[0].message.content&&(w=M.choices[0].message.content,"deepseek"===apiConfig.provider&&apiConfig.reasoning&&M.choices[0].message.reasoning_content&&(P=M.choices[0].message.reasoning_content)),w?(displayMessage(AI_ASSISTANT_NAME,w,!1,AI_AVATAR_CHAR,null,a,P),r(w,!0,P)):(displayMessage(AI_ASSISTANT_NAME,"错误：API响应无效或内容为空。",!1,AI_AVATAR_CHAR,null,a),r(null,!0,null));case 18:e.n=20;break;case 19:e.p=19,"AbortError"===(U=e.v).name?(L=document.getElementById(a),F=(null==L||null===(O=L.querySelector(".message-text"))||void 0===O?void 0:O.innerText)||"",displayMessage(AI_ASSISTANT_NAME,F+"\n[AI 回复已手动停止]",!1,AI_AVATAR_CHAR,null,a),F.trim()&&(currentConversationHistory.push({role:"assistant",content:F+"\n[手动停止]",contextId:conversationContextId}),saveConversationToStorage())):(console.error("API Call Failed:",U),displayMessage(AI_ASSISTANT_NAME,"连接 API 时出错：".concat(U.message),!1,AI_AVATAR_CHAR,null,a)),r(null,!0,null);case 20:return e.p=20,abortController&&!abortController.signal.aborted?(hideTypingIndicator(),stopGeneratingButton.style.display="none",abortController=null):abortController||(hideTypingIndicator(),stopGeneratingButton.style.display="none"),e.f(20);case 21:return e.a(2)}},e,null,[[3,5],[1,19,20,21]])}))).apply(this,arguments)}function fetchModels(){return _fetchModels.apply(this,arguments)}function _fetchModels(){return(_fetchModels=_asyncToGenerator(_regenerator().m(function e(){var t,n,o,a,r,i,s,c,l,u;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(apiConfig.apiKey&&apiConfig.apiUrl){e.n=1;break}return showSettingsStatus("请先填写 API 密钥和地址。","error"),e.a(2);case 1:return t=apiConfig.apiUrl.replace(/\/$/,""),n={"Content-Type":"application/json"},"gemini"===apiConfig.provider?t+="?key=".concat(apiConfig.apiKey):(t+="/models",n.Authorization="Bearer ".concat(apiConfig.apiKey)),fetchModelsButton.disabled=!0,fetchModelsButton.innerHTML='<i class="fas fa-spinner fa-spin mr-1"></i> 获取中...',e.p=2,e.n=3,fetch(t,{method:"GET",headers:n});case 3:if((o=e.v).ok){e.n=5;break}return e.n=4,o.json().catch(function(){return{error:{message:o.statusText}}});case 4:throw r=e.v,i=(null===(a=r.error)||void 0===a?void 0:a.message)||r.message||o.statusText,new Error("(".concat(o.status,"): ").concat(i));case 5:return e.n=6,o.json();case 6:s=e.v,c=[],"gemini"===apiConfig.provider?s.models&&Array.isArray(s.models)&&(c=s.models.filter(function(e){var t;return(null===(t=e.supportedGenerationMethods)||void 0===t?void 0:t.includes("generateContent"))&&e.name&&!e.name.includes("embedContent")&&!e.name.includes("aqa")}).map(function(e){return e.name.startsWith("models/")?e.name.substring(7):e.name}).sort(function(e,t){return e.includes("flash")&&!t.includes("flash")?-1:!e.includes("flash")&&t.includes("flash")?1:e.includes("pro")&&!t.includes("pro")?-1:!e.includes("pro")&&t.includes("pro")?1:e.localeCompare(t)})):s.data&&Array.isArray(s.data)?c=s.data.map(function(e){return e.id}).filter(Boolean).sort():Array.isArray(s)&&(c=s.map(function(e){return"string"==typeof e?e:e.id}).filter(Boolean).sort()),c.length>0?(apiConfig.models=c,settingsModelListInput.value=c.join(","),updateModelSelectDropdown(),apiConfig.defaultModel&&apiConfig.models.includes(apiConfig.defaultModel)||(l=apiConfig.models[0],"gemini"===apiConfig.provider?l=apiConfig.models.find(function(e){return e.includes("flash-latest")})||apiConfig.models.find(function(e){return e.includes("flash")})||apiConfig.models.find(function(e){return e.includes("pro-latest")})||apiConfig.models.find(function(e){return e.includes("pro")})||apiConfig.models[0]:"openai"===apiConfig.provider?l=apiConfig.models.find(function(e){return e.includes("gpt-3.5-turbo")})||apiConfig.models.find(function(e){return e.includes("gpt-4")})||apiConfig.models[0]:"deepseek"===apiConfig.provider&&(l=apiConfig.models.find(function(e){return e.includes("deepseek-chat")})||apiConfig.models[0]),apiConfig.defaultModel=l,settingsModelSelect.value=apiConfig.defaultModel),showSettingsStatus("模型列表已成功获取！","success")):showSettingsStatus("未能获取到模型列表，请检查API配置或手动填写。","warning"),e.n=8;break;case 7:e.p=7,u=e.v,console.error("Fetch models error:",u),showSettingsStatus("获取模型列表出错: ".concat(u.message),"error");case 8:return e.p=8,fetchModelsButton.disabled=!1,fetchModelsButton.innerHTML='<i class="fas fa-cloud-download-alt"></i> 自动获取模型',e.f(8);case 9:return e.a(2)}},e,null,[[2,7,8,9]])}))).apply(this,arguments)}function getSelectedContent(){var e=Office.context.host===Office.HostType.Excel?Office.CoercionType.Table:Office.CoercionType.Text;Office.context.document.getSelectedDataAsync(e,function(e){if(e.status===Office.AsyncResultStatus.Failed)Office.context.host===Office.HostType.Excel?Office.context.document.getSelectedDataAsync(Office.CoercionType.Text,function(e){e.status===Office.AsyncResultStatus.Succeeded?processSelectedContent(e.value,!1):showToast("获取选中内容失败: ".concat(e.error.message),"error")}):showToast("获取选中内容失败: ".concat(e.error.message),"error");else{var t=void 0!==e.value.headers;processSelectedContent(e.value,t)}})}function processSelectedContent(e,t){var n="";if(t){var o=e.headers[0],a=e.rows,r="| ".concat(o.join(" | ")," |"),i="|".concat(o.map(function(){return"---"}).join("|"),"|"),s=a.map(function(e){return"| ".concat(e.join(" | ")," |")}).join("\n");n="".concat(r,"\n").concat(i,"\n").concat(s)}else n=String(e);if(n.trim()){var c=messageInput.value;messageInput.value=c?"".concat(c,"\n\n---\n引用内容:\n").concat(n):n,messageInput.focus(),adjustTextareaHeight(),sendButton.disabled=!1,showToast("已获取选中内容","success")}else showToast("未选中任何内容或内容为空","warning")}function insertContent(e){Office.context.document.setSelectedDataAsync(e,{coercionType:Office.CoercionType.Text},function(e){e.status===Office.AsyncResultStatus.Failed?showToast("插入失败: ".concat(e.error.message),"error"):showToast("内容已插入","success")})}function insertCodeOrFormula(e){var t=e.innerText;t&&insertContent(t)}function addOfficeActionButtons(e){e.querySelectorAll("pre[data-lang]").forEach(function(e){if(!e.querySelector(".insert-code-btn")){var t=e.getAttribute("data-lang"),n=e.querySelector("code");if(n){var o=document.createElement("button");o.className="message-action-btn insert-code-btn",o.style.position="absolute",o.style.top="8px",o.style.right="8px",o.style.zIndex="1","formula"===t.toLowerCase()&&Office.context.host===Office.HostType.Excel?o.innerHTML='<i class="fas fa-calculator mr-1"></i> 插入公式':o.innerHTML='<i class="fas fa-code mr-1"></i> 插入代码',o.onclick=function(e){e.stopPropagation(),insertCodeOrFormula(n)},e.appendChild(o);var a=e.querySelector(".toolbar");a&&(a.style.display="none")}}})}function stopGeneration(){abortController&&(abortController.abort(),showToast("已停止 AI 回复","info"))}function saveConversationToStorage(){try{var e=JSON.parse(localStorage.getItem(STORAGE_KEY_MESSAGES))||{};e[conversationContextId]={u:currentUsername,aC:currentUserAvatarChar,t:Date.now(),m:currentConversationHistory},localStorage.setItem(STORAGE_KEY_MESSAGES,JSON.stringify(e))}catch(e){console.error(e)}}function loadConversationFromStorage(){try{var e=JSON.parse(localStorage.getItem(STORAGE_KEY_MESSAGES))||{};if(e[conversationContextId]){var t=e[conversationContextId];return currentConversationHistory=t.m||[],messageArea.innerHTML='<div class="text-center my-3"><span class="text-xs px-3 py-1.5 rounded-full bg-[var(--bg-accent)] text-[var(--text-secondary)] shadow-sm glassmorphism border-none">加载历史对话</span></div>',currentConversationHistory.forEach(function(e){"user"===e.role?displayMessage(currentUsername,e.content,!0,currentUserAvatarChar):"assistant"===e.role&&displayMessage(AI_ASSISTANT_NAME,e.content,!1,AI_AVATAR_CHAR)}),scrollToBottom(),!0}}catch(e){console.error(e)}return!1}function clearCurrentConversation(){var e,t;showToast('确定要清空当前聊天记录吗？此操作无法撤销。<br><div class="mt-3 flex gap-2 justify-end"><button id="confirmClear" class="btn !bg-[var(--error-color)] !text-white !text-xs !py-1 !px-3">确认清空</button><button id="cancelClear" class="btn btn-secondary !text-xs !py-1 !px-3">取消</button></div>',"warning",1e4),null===(e=document.getElementById("confirmClear"))||void 0===e||e.addEventListener("click",function(){currentConversationHistory=[],messageArea.innerHTML='<div class="text-center my-3"><span class="text-xs px-3 py-1.5 rounded-full bg-[var(--bg-accent)] text-[var(--text-secondary)] shadow-sm glassmorphism border-none">聊天记录已清空</span></div>';var e=JSON.parse(localStorage.getItem(STORAGE_KEY_MESSAGES))||{};e[conversationContextId]&&(delete e[conversationContextId],localStorage.setItem(STORAGE_KEY_MESSAGES,JSON.stringify(e))),showToast("聊天记录已清空","info",2e3),toastTimeout&&clearTimeout(toastTimeout),toastNotification.style.opacity="0"}),null===(t=document.getElementById("cancelClear"))||void 0===t||t.addEventListener("click",function(){toastTimeout&&clearTimeout(toastTimeout),toastNotification.style.opacity="0"})}function clearConversationContext(){conversationContextId=Date.now().toString(),currentConversationHistory=[],messageArea.innerHTML='<div class="text-center my-3"><span class="text-xs px-3 py-1.5 rounded-full bg-[var(--bg-accent)] text-[var(--text-secondary)] shadow-sm glassmorphism border-none">新对话已开始 (上下文已重置)</span></div>',showToast("新对话已开始 (上下文已重置)","info",2500)}function renderUserList(){userList.innerHTML="";var e=document.documentElement.classList.contains("light"),t=e?"3b82f6":"6a82fb",n=e?"ffffff":"e0e7ff",o=e?"10b981":"2dd4bf",a=e?"ffffff":"0d0f1a";userList.appendChild(createUserListItem(currentUsername,currentUserAvatarChar,"online",!1,t,n)),userList.appendChild(createUserListItem(AI_ASSISTANT_NAME,AI_AVATAR_CHAR,"online",!0,o,a))}function createUserListItem(e,t,n,o,a,r){var i=document.createElement("li");i.className="user-list-item flex items-center p-2.5 rounded-lg hover:bg-[var(--bg-accent)] transition duration-150 cursor-pointer group",i.dataset.username=e,i.dataset.isBot=o;var s=document.createElement("img");s.src=getAvatarUrl(t,"40x40",a,r),s.alt=e,s.className="w-9 h-9 rounded-full mr-3 flex-shrink-0 shadow-sm";var c=document.createElement("span");c.className="text-sm font-medium text-[var(--text-primary)] truncate group-hover:text-[var(--text-accent)]",c.textContent=e;var l=document.createElement("span");return l.className="ml-auto w-2.5 h-2.5 rounded-full flex-shrink-0 border-2 border-[var(--bg-secondary)] ".concat("online"===n?o?"bg-sky-400":"bg-green-400 animate-pulseGlow":"bg-gray-400"),o&&"online"===n?l.style.setProperty("--shadow-glow","rgba(56,189,248,0.5)"):o||"online"!==n||l.style.setProperty("--shadow-glow","rgba(74,222,128,0.5)"),i.appendChild(s),i.appendChild(c),i.appendChild(l),i.style.cursor="default",i}function showTypingIndicator(){if(0===typingIndicator.children.length){var e=document.createElement("span");e.innerHTML='<svg class="animate-spin h-4 w-4 mr-1.5 text-[var(--text-accent)] inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> '.concat(AI_ASSISTANT_NAME," 正在解码信息"),typingIndicator.appendChild(e)}}function hideTypingIndicator(){typingIndicator.innerHTML=""}function populateEmojiPicker(){EMOJIS.forEach(function(e){var t=document.createElement("span");t.textContent=e,t.className="p-1.5 rounded-md hover:bg-[var(--bg-accent)] transition-colors text-2xl cursor-pointer",t.addEventListener("click",function(){return insertEmoji(e)}),emojiPicker.appendChild(t)})}function toggleEmojiPicker(e){(void 0!==e?e:emojiPicker.classList.contains("hidden"))?(emojiPicker.classList.remove("hidden"),isEmojiPickerOpen=!0,setTimeout(function(){return document.addEventListener("click",handleClickOutsideEmojiPicker,!0)},0)):(emojiPicker.classList.add("hidden"),isEmojiPickerOpen=!1,document.removeEventListener("click",handleClickOutsideEmojiPicker,!0))}function insertEmoji(e){var t=messageInput.selectionStart,n=messageInput.selectionEnd,o=messageInput.value;messageInput.value=o.substring(0,t)+e+o.substring(n),messageInput.focus(),messageInput.setSelectionRange(t+e.length,t+e.length),adjustTextareaHeight(),sendButton.disabled=""===messageInput.value.trim()}function handleClickOutsideEmojiPicker(e){emojiPicker.contains(e.target)||e.target===emojiButton||emojiButton.contains(e.target)||toggleEmojiPicker(!1)}function adjustTextareaHeight(){messageInput.style.height="auto";var e=Math.max(50,Math.min(messageInput.scrollHeight+2,180));messageInput.style.height="".concat(e,"px")}function renderCustomBodyParamsList(){customBodyParamsList.innerHTML="",apiConfig.customBodyParams&&0!==apiConfig.customBodyParams.length?apiConfig.customBodyParams.forEach(function(e,t){var n=document.createElement("div");n.className="custom-body-param-item flex items-center gap-2 p-2 bg-[var(--bg-accent)] border border-[var(--border-accent)] rounded-md animate-fadeIn",n.innerHTML='<span class="key font-mono text-xs text-[var(--text-accent)]">'.concat(e.key,':</span><span class="value flex-grow font-mono text-xs text-[var(--text-secondary)] overflow-hidden text-ellipsis whitespace-nowrap" title="').concat(e.value,'">').concat(e.value,'</span><button type="button" class="btn-remove-param btn !p-1 !text-xs !bg-transparent !text-[var(--error-color)] hover:!bg-[var(--error-color)] hover:!text-white" data-index="').concat(t,'" title="移除"><i class="fas fa-times"></i></button>'),n.querySelector(".btn-remove-param").addEventListener("click",function(e){return removeCustomBodyParam(parseInt(e.currentTarget.dataset.index))}),customBodyParamsList.appendChild(n)}):customBodyParamsList.innerHTML='<p class="text-xs text-[var(--text-secondary)] italic">尚无自定义参数。</p>'}function addCustomBodyParam(){var e=customBodyKeyInput.value.trim(),t=customBodyValueInput.value.trim();if(!e)return showSettingsStatus("参数名 (Key) 不能为空。","error"),void customBodyKeyInput.focus();if(!t)return showSettingsStatus("参数值 (Value) 不能为空。","error"),void customBodyValueInput.focus();try{JSON.parse(t)}catch(e){if(!confirm("参数值不是有效的JSON。字符串需要用引号包裹。要作为普通字符串添加吗？"))return showSettingsStatus("操作已取消。","info"),void customBodyValueInput.focus()}Array.isArray(apiConfig.customBodyParams)||(apiConfig.customBodyParams=[]),apiConfig.customBodyParams.push({key:e,value:t}),renderCustomBodyParamsList(),saveConfig(),customBodyKeyInput.value="",customBodyValueInput.value="",showSettingsStatus('参数 "'.concat(e,'" 已添加。'),"success")}function removeCustomBodyParam(e){var t;if(null!==(t=apiConfig.customBodyParams)&&void 0!==t&&t[e]){var n=apiConfig.customBodyParams.splice(e,1)[0];renderCustomBodyParamsList(),saveConfig(),showSettingsStatus('参数 "'.concat(n.key,'" 已移除。'),"info")}}function initializeChat(){loadConfig();var e,t=settingsUsernameInput.value.trim();t&&(currentUserAvatarChar=(null===(e=(currentUsername=t).charAt(0))||void 0===e?void 0:e.toUpperCase())||"O"),usernameHeader.textContent=currentUsername,applyTheme("light"===localStorage.getItem(STORAGE_KEY_THEME)),loadConversationFromStorage()||(messageArea.innerHTML='<div class="text-center my-3"><span class="text-xs px-3 py-1.5 rounded-full bg-[var(--bg-accent)] text-[var(--text-secondary)] shadow-sm glassmorphism border-none">开始与AI交流</span></div>'),renderUserList(),navigateTo("chatPage"),messageInput.focus()}function initializeApp(){console.log("Initializing AI Stardust Chat Add-in..."),configureMarkdown(),populateEmojiPicker(),initializeChat(),sendButton.addEventListener("click",sendMessage),messageInput.addEventListener("keypress",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendButton.disabled||sendMessage())}),messageInput.addEventListener("input",function(){adjustTextareaHeight(),sendButton.disabled=""===messageInput.value.trim()||null!=abortController}),stopGeneratingButton.addEventListener("click",stopGeneration),settingsButton.addEventListener("click",function(){return navigateTo("settingsPage")}),profileButton.addEventListener("click",function(){return showToast("个人信息功能已简化。请在设置中修改您的代号。","info")}),closeSettingsButton.addEventListener("click",function(){return navigateTo("chatPage")}),apiSettingsForm.addEventListener("submit",function(e){var t;e.preventDefault();var n,o=settingsUsernameInput.value.trim();if(o&&o!==currentUsername)currentUsername=o,currentUserAvatarChar=(null===(n=o.charAt(0))||void 0===n?void 0:n.toUpperCase())||"O",usernameHeader.textContent=currentUsername,applyTheme(document.documentElement.classList.contains("light")),renderUserList();else if(!o)return void showSettingsStatus("代号不能为空！","error");if(apiConfig.provider=(null===(t=document.querySelector('input[name="apiProvider"]:checked'))||void 0===t?void 0:t.value)||"gemini",apiConfig.apiKey=settingsApiKeyInput.value.trim(),"custom"===apiConfig.provider?apiConfig.apiUrl=settingsApiUrlInput.value.trim():updateApiUrlForProvider(apiConfig.provider,!1),apiConfig.models=settingsModelListInput.value.split(",").map(function(e){return e.trim()}).filter(Boolean),apiConfig.defaultModel=settingsModelSelect.value,apiConfig.streaming=settingsStreamingEnabled.checked,apiConfig.reasoning="deepseek"===apiConfig.provider&&settingsReasoningEnabled.checked,apiConfig.aiStyle=aiStyleSelect.value,apiConfig.aiStyleStrength=parseFloat(aiStyleStrength.value),!apiConfig.apiKey)return showSettingsStatus("API 密钥不能为空！","error"),void settingsApiKeyInput.focus();if("custom"===apiConfig.provider&&!apiConfig.apiUrl)return showSettingsStatus("自定义 API 地址不能为空！","error"),void settingsApiUrlInput.focus();if(0===apiConfig.models.length)return showSettingsStatus("可用模型列表不能为空！","error"),void settingsModelListInput.focus();if(!apiConfig.defaultModel&&apiConfig.models.length>0)apiConfig.defaultModel=apiConfig.models[0],settingsModelSelect.value=apiConfig.defaultModel;else if(!apiConfig.defaultModel&&0===apiConfig.models.length)return showSettingsStatus("请选择或获取一个默认模型！","error"),void settingsModelSelect.focus();saveConfig()?(showSettingsStatus("配置已成功应用并保存！","success"),updateModelSelectDropdown()):showSettingsStatus("保存配置时出错。","error")}),apiProviderRadios.forEach(function(e){return e.addEventListener("change",function(e){apiConfig.provider=e.target.value,updateApiUrlForProvider(apiConfig.provider,!1),updateApiUrlVisibility(),apiConfig.models=[],apiConfig.defaultModel="",settingsModelListInput.value="",updateModelSelectDropdown()})}),settingsModelListInput.addEventListener("input",function(){apiConfig.models=settingsModelListInput.value.split(",").map(function(e){return e.trim()}).filter(Boolean),updateModelSelectDropdown(),apiConfig.defaultModel&&!apiConfig.models.includes(apiConfig.defaultModel)&&apiConfig.models.length>0?(settingsModelSelect.value=apiConfig.models[0],apiConfig.defaultModel=apiConfig.models[0]):0===apiConfig.models.length&&(settingsModelSelect.value="",apiConfig.defaultModel="")}),fetchModelsButton.addEventListener("click",fetchModels),clearChatButton.addEventListener("click",clearCurrentConversation),clearContextButton.addEventListener("click",clearConversationContext),themeToggleButton.addEventListener("click",toggleTheme),darkModeToggle.addEventListener("change",function(){applyTheme(darkModeToggle.checked),localStorage.setItem(STORAGE_KEY_THEME,darkModeToggle.checked?"light":"dark")}),emojiButton.addEventListener("click",function(e){e.stopPropagation(),toggleEmojiPicker()}),addCustomBodyParamButton.addEventListener("click",addCustomBodyParam),getSelectionButton.addEventListener("click",getSelectedContent),console.log("AI Stardust Chat Add-in loaded successfully.")}