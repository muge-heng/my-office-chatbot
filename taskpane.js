/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={58394:function(e,t,n){"use strict";e.exports=n.p+"284515e8d385f6792dcd.css"},60947:function(e,t,n){"use strict";e.exports=n.p+"68eb404b20789ad009ac.js"}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}n.m=e,n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e}(),n.b=document.baseURI||self.location.href,function(){function e(){var n,r,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",i=o.toStringTag||"@@toStringTag";function c(e,o,a,i){var c=o&&o.prototype instanceof l?o:l,u=Object.create(c.prototype);return t(u,"_invoke",function(e,t,o){var a,i,c,l=0,u=o||[],d=!1,m={p:0,n:0,v:n,a:f,f:f.bind(n,4),d:function(e,t){return a=e,i=0,c=n,m.n=t,s}};function f(e,t){for(i=e,c=t,r=0;!d&&l&&!o&&r<u.length;r++){var o,a=u[r],f=m.p,p=a[2];e>3?(o=p===t)&&(c=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=n):a[0]<=f&&((o=e<2&&f<a[1])?(i=0,m.v=t,m.n=a[1]):f<p&&(o=e<3||a[0]>t||t>p)&&(a[4]=e,a[5]=t,m.n=p,i=0))}if(o||e>1)return s;throw d=!0,t}return function(o,u,p){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&f(u,p),i=u,c=p;(r=i<2?n:c)||!d;){a||(i?i<3?(i>1&&(m.n=-1),f(i,c)):m.n=c:m.v=c);try{if(l=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,c)))throw TypeError("iterator result is not an object");if(!r.done)return r;c=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=n}else if((r=(d=m.n<0)?c:e.call(t,m))!==s)break}catch(e){a=n,i=1,c=e}finally{l=1}}return{value:r,done:d}}}(e,a,i),!0),u}var s={};function l(){}function u(){}function d(){}r=Object.getPrototypeOf;var m=[][a]?r(r([][a]())):(t(r={},a,function(){return this}),r),f=d.prototype=l.prototype=Object.create(m);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,t(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return u.prototype=d,t(f,"constructor",d),t(d,"constructor",u),u.displayName="GeneratorFunction",t(d,i,"GeneratorFunction"),t(f),t(f,i,"Generator"),t(f,a,function(){return this}),t(f,"toString",function(){return"[object Generator]"}),(e=function(){return{w:c,m:p}})()}function t(e,n,r,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}t=function(e,n,r,o){if(n)a?a(e,n,{value:r,enumerable:!o,configurable:!o,writable:!o}):e[n]=r;else{var i=function(n,r){t(e,n,function(e){return this._invoke(n,r,e)})};i("next",0),i("throw",1),i("return",2)}},t(e,n,r,o)}function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(e,t,n,r,o,a,i){try{var c=e[a](i),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,o)}function o(e){return function(){var t=this,n=arguments;return new Promise(function(o,a){var i=e.apply(t,n);function c(e){r(i,o,a,c,s,"next",e)}function s(e){r(i,o,a,c,s,"throw",e)}c(void 0)})}}function a(e){return function(e){if(Array.isArray(e))return i(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return i(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach(function(t){l(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function l(e,t,r){return(t=function(e){var t=function(e){if("object"!=n(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=n(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==n(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Office.onReady(function(e){e.host!==Office.HostType.Word&&e.host!==Office.HostType.Excel&&e.host!==Office.HostType.PowerPoint||(console.log("Initializing AI Stardust Chat Add-in..."),function(){marked.setOptions({breaks:!1,gfm:!0,highlight:function(e,t){var n=t||"plaintext";return Prism.languages[n]?Prism.highlight(e,Prism.languages[n],n):e}});var e=new marked.Renderer;e.code=function(e,t,n){var r=(t||"").match(/\S*/)[0],o=this.options.highlight(e,r),a=r?"".concat(this.options.langPrefix).concat(r):"".concat(this.options.langPrefix,"plaintext");return'<pre class="'.concat(a,'" data-lang="').concat(r||"plaintext",'"><code class="').concat(a,'">').concat(o,"\n</code></pre>\n")};var t=e.paragraph.bind(e);e.paragraph=function(e){return e=(e=e.replace(/\$(.+?)\$/g,function(e,t){try{return katex.renderToString(t,{throwOnError:!1,displayMode:!1})}catch(t){return'<span class="katex-error" title="'.concat(t.message,'">').concat(e,"</span>")}})).replace(/\$\$([\s\S]+?)\$\$/g,function(e,t){try{return katex.renderToString(t.trim(),{throwOnError:!1,displayMode:!0})}catch(e){return'<div class="katex-error" title="'.concat(e.message,'"><pre>').concat(t.trim(),"</pre></div>")}}),t(e)},marked.use({renderer:e})}(),f.forEach(function(e){var t=document.createElement("span");t.textContent=e,t.className="p-1.5 rounded-md hover:bg-[var(--bg-accent)] transition-colors text-2xl cursor-pointer",t.addEventListener("click",function(){return function(e){var t=E.selectionStart,n=E.selectionEnd,r=E.value;E.value=r.substring(0,t)+e+r.substring(n),E.focus(),E.setSelectionRange(t+e.length,t+e.length),$e(),D.disabled=""===E.value.trim()}(e)}),F.appendChild(t)}),function(){!function(){var e=localStorage.getItem(y);if(e)try{var t=JSON.parse(e);me=s(s({},me),t),Array.isArray(me.models)||(me.models=[]),Array.isArray(me.customBodyParams)||(me.customBodyParams=[])}catch(e){console.error("Failed to parse saved API config:",e),he("无法加载API配置，使用默认设置。","error"),localStorage.removeItem(y)}"custom"!==me.provider?xe(me.provider,!1):"custom"!==me.provider||me.apiUrl||(me.apiUrl="");var n,r=P.value.trim();r&&(ue=(null===(n=(le=r).charAt(0))||void 0===n?void 0:n.toUpperCase())||"O",k.textContent=le),Be(),ze()}();var e,t=P.value.trim();t&&(ue=(null===(e=(le=t).charAt(0))||void 0===e?void 0:e.toUpperCase())||"O"),k.textContent=le,Ee("light"===localStorage.getItem(h)),function(){try{var e=JSON.parse(localStorage.getItem(v))||{};if(e[ge]){var t=e[ge];return de=t.m||[],b.innerHTML='<div class="text-center my-3"><span class="text-xs px-3 py-1.5 rounded-full bg-[var(--bg-accent)] text-[var(--text-secondary)] shadow-sm glassmorphism border-none">加载历史对话</span></div>',de.forEach(function(e){"user"===e.role?Ie(le,e.content,!0,ue):"assistant"===e.role&&Ie(d,e.content,!1,m)}),ye(),!0}}catch(e){console.error(e)}return!1}()||(b.innerHTML='<div class="text-center my-3"><span class="text-xs px-3 py-1.5 rounded-full bg-[var(--bg-accent)] text-[var(--text-secondary)] shadow-sm glassmorphism border-none">开始与AI交流</span></div>'),Re(),be("chatPage"),E.focus()}(),D.addEventListener("click",Fe),E.addEventListener("keypress",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),D.disabled||Fe())}),E.addEventListener("input",function(){$e(),D.disabled=""===E.value.trim()||null!=fe}),T.addEventListener("click",Ue),C.addEventListener("click",function(){return be("settingsPage")}),w.addEventListener("click",function(){return he("个人信息功能已简化。请在设置中修改您的代号。","info")}),O.addEventListener("click",function(){return be("chatPage")}),H.addEventListener("submit",function(e){var t;e.preventDefault();var n,r=P.value.trim();if(r&&r!==le)le=r,ue=(null===(n=r.charAt(0))||void 0===n?void 0:n.toUpperCase())||"O",k.textContent=le,Ee(document.documentElement.classList.contains("light")),Re();else if(!r)return void Ae("代号不能为空！","error");if(me.provider=(null===(t=document.querySelector('input[name="apiProvider"]:checked'))||void 0===t?void 0:t.value)||"gemini",me.apiKey=R.value.trim(),"custom"===me.provider?me.apiUrl=G.value.trim():xe(me.provider,!1),me.models=V.value.split(",").map(function(e){return e.trim()}).filter(Boolean),me.defaultModel=W.value,me.streaming=Q.checked,me.reasoning="deepseek"===me.provider&&X.checked,me.aiStyle=ee.value,me.aiStyleStrength=parseFloat(te.value),!me.apiKey)return Ae("API 密钥不能为空！","error"),void R.focus();if("custom"===me.provider&&!me.apiUrl)return Ae("自定义 API 地址不能为空！","error"),void G.focus();if(0===me.models.length)return Ae("可用模型列表不能为空！","error"),void V.focus();if(!me.defaultModel&&me.models.length>0)me.defaultModel=me.models[0],W.value=me.defaultModel;else if(!me.defaultModel&&0===me.models.length)return Ae("请选择或获取一个默认模型！","error"),void W.focus();ke()?(Ae("配置已成功应用并保存！","success"),Be()):Ae("保存配置时出错。","error")}),q.forEach(function(e){return e.addEventListener("change",function(e){me.provider=e.target.value,xe(me.provider,!1),Se(),me.models=[],me.defaultModel="",V.value="",Be()})}),V.addEventListener("input",function(){me.models=V.value.split(",").map(function(e){return e.trim()}).filter(Boolean),Be(),me.defaultModel&&!me.models.includes(me.defaultModel)&&me.models.length>0?(W.value=me.models[0],me.defaultModel=me.models[0]):0===me.models.length&&(W.value="",me.defaultModel="")}),Y.addEventListener("click",Te),j.addEventListener("click",Ne),U.addEventListener("click",qe),B.addEventListener("click",De),M.addEventListener("change",function(){Ee(M.checked),localStorage.setItem(h,M.checked?"light":"dark")}),I.addEventListener("click",function(e){e.stopPropagation(),Ke()}),ae.addEventListener("click",Ve),se.addEventListener("click",Pe),console.log("AI Stardust Chat Add-in loaded successfully."))});var u,d="星尘AI",m="✨",f=["😀","😂","😊","😍","🤔","👍","🎉","❤️","🚀","💡","💯","🙏","👋","🔥","👀","🌟","💻","🤖","✨","🥳","🤯","🙌","🤞","🧠","🧑‍💻","🌌","🌠","🛰️","👽"],p=60,g=12,v="aiStardustChatMessages_v4_1_office",y="aiStardustChatApiConfig_v4_1_office",h="aiStardustChatTheme_v4_1_office",b=(document.getElementById("appContainer"),document.getElementById("chatPage"),document.getElementById("settingsPage"),document.getElementById("messageArea")),E=document.getElementById("messageInput"),D=document.getElementById("sendButton"),x=document.getElementById("userList"),k=document.getElementById("usernameHeader"),S=document.getElementById("userAvatarHeader"),B=document.getElementById("themeToggleButton"),A=B.querySelector("i"),C=document.getElementById("settingsButton"),w=document.getElementById("profileButton"),I=document.getElementById("emojiButton"),F=document.getElementById("emojiPicker"),L=document.getElementById("typingIndicator"),T=document.getElementById("stopGeneratingButton"),O=document.getElementById("closeSettingsButton"),P=document.getElementById("settingsUsernameInput"),M=document.getElementById("darkModeToggle"),j=document.getElementById("clearChatButton"),U=document.getElementById("clearContextButton"),H=document.getElementById("apiSettingsForm"),N=document.getElementById("settingsStatusIndicator"),q=document.querySelectorAll('input[name="apiProvider"]'),R=document.getElementById("settingsApiKey"),_=document.getElementById("settingsApiUrlGroup"),G=document.getElementById("settingsApiUrl"),K=document.getElementById("settingsDefaultApiUrls"),J=document.getElementById("settingsDeepseekUrl"),$=document.getElementById("settingsOpenaiUrl"),z=document.getElementById("settingsGeminiUrl"),V=document.getElementById("settingsModelList"),W=document.getElementById("settingsModelSelect"),Y=document.getElementById("fetchModelsButton"),Q=document.getElementById("settingsStreamingEnabled"),X=document.getElementById("settingsReasoningEnabled"),Z=document.getElementById("reasoningOptionContainer"),ee=document.getElementById("aiStyleSelect"),te=document.getElementById("aiStyleStrength"),ne=(document.getElementById("saveSettingsButton"),document.getElementById("customApiSettingsSection")),re=document.getElementById("customBodyKey"),oe=document.getElementById("customBodyValue"),ae=document.getElementById("addCustomBodyParamButton"),ie=document.getElementById("customBodyParamsList"),ce=document.getElementById("toastNotification"),se=document.getElementById("getSelectionButton"),le="Office User",ue="O",de=[],me={provider:"gemini",apiKey:"",apiUrl:"https://generativelanguage.googleapis.com/v1beta/models/",models:[],defaultModel:"",streaming:!0,reasoning:!1,aiStyle:"default",aiStyleStrength:1,customBodyParams:[]},fe=null,pe=!1,ge=Date.now().toString();function ve(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"36x36",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"82a9ff",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"0d0f1a",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"orbitron";if(/(?:[#\*0-9\xA9\xAE\u203C\u2049\u2122\u2139\u2194-\u2199\u21A9\u21AA\u231A\u231B\u2328\u23CF\u23E9-\u23F3\u23F8-\u23FA\u24C2\u25AA\u25AB\u25B6\u25C0\u25FB-\u25FE\u2600-\u2604\u260E\u2611\u2614\u2615\u2618\u261D\u2620\u2622\u2623\u2626\u262A\u262E\u262F\u2638-\u263A\u2640\u2642\u2648-\u2653\u265F\u2660\u2663\u2665\u2666\u2668\u267B\u267E\u267F\u2692-\u2697\u2699\u269B\u269C\u26A0\u26A1\u26A7\u26AA\u26AB\u26B0\u26B1\u26BD\u26BE\u26C4\u26C5\u26C8\u26CE\u26CF\u26D1\u26D3\u26D4\u26E9\u26EA\u26F0-\u26F5\u26F7-\u26FA\u26FD\u2702\u2705\u2708-\u270D\u270F\u2712\u2714\u2716\u271D\u2721\u2728\u2733\u2734\u2744\u2747\u274C\u274E\u2753-\u2755\u2757\u2763\u2764\u2795-\u2797\u27A1\u27B0\u27BF\u2934\u2935\u2B05-\u2B07\u2B1B\u2B1C\u2B50\u2B55\u3030\u303D\u3297\u3299]|\uD83C[\uDC04\uDCCF\uDD70\uDD71\uDD7E\uDD7F\uDD8E\uDD91-\uDD9A\uDDE6-\uDDFF\uDE01\uDE02\uDE1A\uDE2F\uDE32-\uDE3A\uDE50\uDE51\uDF00-\uDF21\uDF24-\uDF93\uDF96\uDF97\uDF99-\uDF9B\uDF9E-\uDFF0\uDFF3-\uDFF5\uDFF7-\uDFFF]|\uD83D[\uDC00-\uDCFD\uDCFF-\uDD3D\uDD49-\uDD4E\uDD50-\uDD67\uDD6F\uDD70\uDD73-\uDD7A\uDD87\uDD8A-\uDD8D\uDD90\uDD95\uDD96\uDDA4\uDDA5\uDDA8\uDDB1\uDDB2\uDDBC\uDDC2-\uDDC4\uDDD1-\uDDD3\uDDDC-\uDDDE\uDDE1\uDDE3\uDDE8\uDDEF\uDDF3\uDDFA-\uDE4F\uDE80-\uDEC5\uDECB-\uDED2\uDED5-\uDED7\uDEDC-\uDEE5\uDEE9\uDEEB\uDEEC\uDEF0\uDEF3-\uDEFC\uDFE0-\uDFEB\uDFF0]|\uD83E[\uDD0C-\uDD3A\uDD3C-\uDD45\uDD47-\uDDFF\uDE70-\uDE7C\uDE80-\uDE89\uDE8F-\uDEC6\uDECE-\uDEDC\uDEDF-\uDEE9\uDEF0-\uDEF8])/.test(e)){var a=document.createElement("canvas"),i=a.getContext("2d"),c=window.devicePixelRatio||1,s=parseInt(t.split("x")[0])*c;return a.width=s,a.height=s,i.fillStyle="#".concat(n),i.fillRect(0,0,s,s),i.textAlign="center",i.textBaseline="middle",i.font="".concat(.65*s,"px sans-serif"),i.fillText(e,s/2,s/2+.08*s),a.toDataURL()}return"https://placehold.co/".concat(t,"/").concat(n,"/").concat(r,"?text=").concat(encodeURIComponent(e.toUpperCase()),"&font=").concat(o)}function ye(){setTimeout(function(){b.scrollTo({top:b.scrollHeight,behavior:"smooth"})},50)}function he(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3500;u&&clearTimeout(u);var r="fa-info-circle";"success"===t?r="fa-check-circle":"error"===t?r="fa-times-circle":"warning"===t&&(r="fa-exclamation-triangle"),ce.innerHTML='<i class="fas '.concat(r,' mr-3 text-xl"></i> <div class="flex-1">').concat(e,"</div>"),ce.className="fixed bottom-6 right-6 z-[200] transition-all duration-300 px-5 py-4 rounded-xl shadow-xl text-sm font-medium flex items-start min-w-[300px] max-w-md",ce.classList.remove("opacity-0","translate-y-5","scale-95","success","error","warning","info"),"success"===t?(ce.style.backgroundColor="var(--success-color)",ce.style.color="white"):"error"===t?(ce.style.backgroundColor="var(--error-color)",ce.style.color="white"):"warning"===t?(ce.style.backgroundColor="var(--warning-color)",ce.style.color=document.documentElement.classList.contains("light")?"#573a00":"#fef3c7"):(ce.style.backgroundColor="var(--text-accent)",ce.style.color="white"),requestAnimationFrame(function(){ce.style.opacity="1",ce.style.transform="translateY(0) scale(1)"}),u=setTimeout(function(){ce.style.opacity="0",ce.style.transform="translateY(5px) scale(0.95)"},n)}function be(e){document.querySelectorAll(".page").forEach(function(t){t.id===e?t.classList.contains("hidden")&&(t.classList.remove("hidden"),t.classList.add("entering"),requestAnimationFrame(function(){return requestAnimationFrame(function(){return t.classList.remove("entering")})})):t.classList.contains("hidden")||t.classList.add("hidden")}),"chatPage"!==e&&pe&&Ke(!1),"settingsPage"===e&&function(){P.value=le;var e=document.querySelector('input[name="apiProvider"][value="'.concat(me.provider,'"]'));e&&(e.checked=!0),R.value=me.apiKey,G.value=me.apiUrl,V.value=me.models.join(","),Q.checked=me.streaming,X.checked=me.reasoning,ee.value=me.aiStyle,te.value=me.aiStyleStrength,Se(),Be(),ze()}()}function Ee(e){var t=document.documentElement;e?(t.classList.add("light"),A.classList.remove("fa-moon"),A.classList.add("fa-sun"),M&&(M.checked=!0)):(t.classList.remove("light"),A.classList.remove("fa-sun"),A.classList.add("fa-moon"),M&&(M.checked=!1)),S.src=ve(ue,"36x36",e?"3b82f6":"82a9ff",e?"ffffff":"0d0f1a"),Re(),setTimeout(function(){return Prism.highlightAll()},50)}function De(){var e=document.documentElement.classList.toggle("light");Ee(e),localStorage.setItem(h,e?"light":"dark")}function xe(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];switch(e){case"deepseek":me.apiUrl="https://api.deepseek.com/v1";break;case"openai":me.apiUrl="https://api.openai.com/v1";break;case"gemini":default:me.apiUrl="https://generativelanguage.googleapis.com/v1beta/models/";case"custom":}G&&"custom"!==e&&(G.value=me.apiUrl),t&&ke()}function ke(){try{return localStorage.setItem(y,JSON.stringify(me)),!0}catch(e){return console.error("Failed to save API config:",e),he("保存API配置失败！","error"),!1}}function Se(){var e,t=(null===(e=document.querySelector('input[name="apiProvider"]:checked'))||void 0===e?void 0:e.value)||me.provider;_.style.display="custom"===t?"block":"none",ne.style.display="custom"===t?"block":"none",K.style.display="custom"!==t?"block":"none","custom"!==t&&(J.style.display="deepseek"===t?"block":"none",$.style.display="openai"===t?"block":"none",z.style.display="gemini"===t?"block":"none"),Z.style.display="deepseek"===t?"block":"none","deepseek"!==t&&(X.checked=!1)}function Be(){if(W.innerHTML="",me.models&&me.models.length>0)me.models.forEach(function(e){var t=document.createElement("option");t.value=e,t.textContent=e,W.appendChild(t)}),W.value=me.defaultModel||me.models[0];else{var e=document.createElement("option");e.value="",e.textContent="-- 无可用模型 --",W.appendChild(e)}}function Ae(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",n="fa-info-circle";"success"===t?n="fa-check-circle":"error"===t?n="fa-times-circle":"warning"===t&&(n="fa-exclamation-triangle"),N.innerHTML='<i class="fas '.concat(n,' mr-2.5 text-lg"></i> ').concat(e),N.className="status-indicator fixed top-5 right-5 z-[100] glassmorphism !p-3 !rounded-xl flex items-center",N.style.color="success"===t?"var(--success-color)":"error"===t?"var(--error-color)":"warning"===t?"var(--warning-color)":"var(--text-accent)",N.style.display="flex",setTimeout(function(){N.style.display="none"},4e3)}function Ce(e){"undefined"!=typeof Prism&&(Prism.highlightAllUnder(e||document.body),(e||document.body).querySelectorAll("pre[data-lang]").forEach(function(e){if(!e.querySelector(".insert-code-btn")){var t=e.getAttribute("data-lang"),n=e.querySelector("code");if(n){var r=document.createElement("button");r.className="message-action-btn insert-code-btn",r.style.position="absolute",r.style.top="8px",r.style.right="8px",r.style.zIndex="1","formula"===t.toLowerCase()&&Office.context.host===Office.HostType.Excel?r.innerHTML='<i class="fas fa-calculator mr-1"></i> 插入公式':r.innerHTML='<i class="fas fa-code mr-1"></i> 插入代码',r.onclick=function(e){e.stopPropagation(),function(e){var t=e.innerText;t&&je(t)}(n)},e.appendChild(r);var o=e.querySelector(".toolbar");o&&(o.style.display="none")}}}))}function we(e){var t=marked.parse(e);return DOMPurify.sanitize(t,{USE_PROFILES:{html:!0},ADD_TAGS:["math","annotation","semantics","mtext","mn","mo","mi","mspace","mover","munder","munderover","mstyle","mfrac","msqrt","mroot","mtable","mtr","mtd","mlabeledtr"],ADD_ATTR:["encoding","xmlns","class","style","aria-hidden","title","start","data-lang"]})}function Ie(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"?",o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(t||n||a||o){var i=o||"msg-".concat(Date.now(),"-").concat(Math.random().toString(16).slice(2)),c=document.getElementById(i);if(c&&!n){var s=c.querySelector(".message-bubble"),l=s.querySelector(".message-text");if(l&&(l.innerHTML=we(t||""),Ce(l)),"deepseek"===me.provider&&me.reasoning&&null!==a){var u=s.querySelector(".reasoning-content");!u&&a&&((u=document.createElement("div")).className="reasoning-content",s.insertBefore(u,l)),u&&(u.textContent=a)}return ye(),c}var m=document.createElement("div");m.id=i,m.classList.add("flex","items-start","max-w-full","group","mb-1.5","py-2");var f=document.documentElement.classList.contains("light"),g=n?f?"3b82f6":"6a82fb":e===d?f?"10b981":"2dd4bf":"a0a8c0",v=n?f?"ffffff":"e0e7ff":e===d?f?"ffffff":"0d0f1a":"1a1c2d",y=document.createElement("img");y.src=ve(r,"36x36",g,v),y.alt="".concat(e," avatar"),y.classList.add("w-9","h-9","rounded-full","flex-shrink-0","shadow-md","border-2","border-[var(--bg-secondary)]");var h=document.createElement("div");h.className="flex flex-col mx-2.5 flex-grow min-w-0";var E=document.createElement("div");E.classList.add("message-bubble","relative"),E.classList.add(n?"my-message":"other-message");var D=document.createElement("div");if(D.classList.add("message-text","break-words"),D.innerHTML=e!==d||t?we(t||""):"",E.appendChild(D),"deepseek"===me.provider&&me.reasoning&&a&&!n){var x=document.createElement("div");x.className="reasoning-content",x.textContent=a,E.appendChild(x)}if(h.appendChild(E),!n&&t){var k=document.createElement("div");k.className="message-actions mt-1.5";var S=document.createElement("button");S.className="message-action-btn",S.innerHTML='<i class="fas fa-file-download mr-1"></i> 插入全文',S.onclick=function(){return je(D.innerText)},k.appendChild(S),h.appendChild(k)}for(n?(m.classList.add("justify-end"),h.classList.add("items-end"),m.appendChild(h),m.appendChild(y)):(m.classList.add("justify-start"),h.classList.add("items-start"),m.appendChild(y),m.appendChild(h)),b.appendChild(m);b.children.length>p+1;){var B;if(null!==(B=b.firstElementChild)&&void 0!==B&&B.querySelector(".text-xs.px-2")){if(!(b.children.length>2))break;b.removeChild(b.children[1])}else b.removeChild(b.firstElementChild)}return t&&Ce(E),(t||n)&&ye(),m}}function Fe(){var e=E.value.trim();if(e)if(fe)he("AI 正在回复，请稍候...","warning");else{var t="请在回复时遵循以下规则：如果你需要提供Excel公式，必须使用Markdown的代码框格式，并标记语言为 `formula`，例如：```formula\n=SUM(A1:A10)\n```。对于其他代码，也请使用对应的语言标记。";if("default"!==me.aiStyle){switch(me.aiStyle){case"professional":t+=" 请用专业、严谨的语气回答。";break;case"friendly":t+=" 请用友好、亲切的语气回答。";break;case"humorous":t+=" 请用幽默、风趣的语气回答。";break;case"concise":t+=" 请用简洁、直接的方式回答。";break;case"detailed":t+=" 请提供详细、全面的回答。"}me.aiStyleStrength>1.1?t+=" (风格强度: ".concat(me.aiStyleStrength,", 请更强调此风格)"):me.aiStyleStrength<.9&&(t+=" (风格强度: ".concat(me.aiStyleStrength,", 请柔和表达此风格)"))}var n=[];if("openai"===me.provider||"deepseek"===me.provider||"custom"===me.provider)t&&n.push({role:"system",content:t}),(n=[].concat(a(n),a(de.slice(-g).map(function(e){return{role:e.role,content:e.content}})))).push({role:"user",content:e});else if("gemini"===me.provider){var r=e;de.slice(-g).forEach(function(e){n.push({role:"assistant"===e.role?"model":"user",parts:[{text:e.content}]})}),t&&0===n.length&&(r=t+"\n\n"+e),n.push({role:"user",parts:[{text:r}]})}if(Ie(le,e,!0,ue),de.push({role:"user",content:e,contextId:ge}),He(),E.value="",E.style.height="auto",E.focus(),D.disabled=!0,pe&&Ke(!1),me.apiKey&&me.apiUrl)if(me.defaultModel){var o="msg-ai-".concat(Date.now());Ie(d,"",!1,m,null,o),function(){if(0===L.children.length){var e=document.createElement("span");e.innerHTML='<svg class="animate-spin h-4 w-4 mr-1.5 text-[var(--text-accent)] inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> '.concat(d," 正在解码信息"),L.appendChild(e)}}(),T.style.display="inline-flex",fe=new AbortController,function(e,t,n,r,o){Le.apply(this,arguments)}(me.defaultModel,n,me.streaming,o,function(e,t,n){if(t){Ge(),T.style.display="none",fe=null;var r=document.getElementById(o);if(r){var a,i=(null===(a=r.querySelector(".message-text"))||void 0===a?void 0:a.innerText)||"[空响应]",c=de.filter(function(e){return"assistant"===e.role}).pop();for(c&&c.content===i||(de.push({role:"assistant",content:i,contextId:ge}),He());de.length>2*p;)de.shift()}}})}else Ie(d,"错误：未选择默认模型。请在设置中选择。",!1,m);else Ie(d,"错误：API 密钥或地址未配置。请在设置中配置。",!1,m)}}function Le(){return(Le=o(e().m(function t(n,r,o,a,i){var c,s,l,u,f,p,g,v,y,h,b,E,D,x,k,S,B,A,C,w,I,F,L,O,P,M,j,U,H,N,q,R;return e().w(function(e){for(;;)switch(e.n){case 0:return c=me.apiUrl.replace(/\/$/,""),s={"Content-Type":"application/json"},"gemini"!==me.provider&&(s.Authorization="Bearer ".concat(me.apiKey)),l={},u=n,"gemini"===me.provider?(c+="/".concat(u,":streamGenerateContent?key=").concat(me.apiKey,"&alt=sse"),l={contents:r}):(c+="/chat/completions",u="deepseek"===me.provider&&me.reasoning?"deepseek-reasoner":n,l={model:u,messages:r,stream:o}),"custom"===me.provider&&Array.isArray(me.customBodyParams)&&me.customBodyParams.forEach(function(e){try{l[e.key]=JSON.parse(e.value)}catch(t){l[e.key]=e.value}}),f=JSON.stringify(l),e.p=1,e.n=2,fetch(c,{method:"POST",headers:s,body:f,signal:null===(p=fe)||void 0===p?void 0:p.signal});case 2:if((g=e.v).ok){e.n=7;break}return e.p=3,e.n=4,g.json();case 4:y=e.v,e.n=6;break;case 5:e.p=5,e.v,y={error:{message:g.statusText}};case 6:return h=(null===(v=y.error)||void 0===v?void 0:v.message)||y.message||g.statusText,b="API Error (".concat(g.status,"): ").concat(h),console.error(b,y),Ie(d,"抱歉，请求出错：".concat(b),!1,m,null,a),i(null,!0,null),e.a(2);case 7:if(!o&&"gemini"!==me.provider||!g.body){e.n=16;break}E=g.body.getReader(),D=new TextDecoder,x="",k="",S="";case 8:return e.n=9,E.read();case 9:if(B=e.v,A=B.done,C=B.value,!A){e.n=10;break}return e.a(3,15);case 10:x+=D.decode(C,{stream:!0}),w=void 0;case 11:if(!((w=x.indexOf("\n"))>=0)){e.n=14;break}if(I=x.substring(0,w).trim(),x=x.substring(w+1),!I.startsWith("data:")){e.n=13;break}if("[DONE]"!==(F=I.substring(5).trim())||"gemini"===me.provider){e.n=12;break}return E.cancel(),i(k,!0,S),e.a(2);case 12:try{L=JSON.parse(F),O="",P=null,"gemini"===me.provider?L.candidates&&L.candidates[0].content&&L.candidates[0].content.parts&&L.candidates[0].content.parts[0].text&&(O=L.candidates[0].content.parts[0].text):L.choices&&L.choices[0].delta&&(L.choices[0].delta.content&&(O=L.choices[0].delta.content),"deepseek"===me.provider&&me.reasoning&&L.choices[0].delta.reasoning_content&&(P=L.choices[0].delta.reasoning_content)),O&&(k+=O),P&&(S+=P),Ie(d,k,!1,m,null,a,"deepseek"===me.provider?S:null)}catch(e){console.warn("Failed to parse stream data line:",F,e)}case 13:e.n=11;break;case 14:e.n=8;break;case 15:i(k,!0,"deepseek"===me.provider?S:null),e.n=18;break;case 16:return e.n=17,g.json();case 17:M=e.v,j="",U=null,"gemini"===me.provider?M.candidates&&M.candidates[0].content&&M.candidates[0].content.parts&&M.candidates[0].content.parts[0].text?j=M.candidates[0].content.parts[0].text:M.promptFeedback&&M.promptFeedback.blockReason&&(j="请求被阻止: ".concat(M.promptFeedback.blockReason),M.promptFeedback.blockReasonMessage&&(j+=" - ".concat(M.promptFeedback.blockReasonMessage))):M.choices&&M.choices[0].message&&M.choices[0].message.content&&(j=M.choices[0].message.content,"deepseek"===me.provider&&me.reasoning&&M.choices[0].message.reasoning_content&&(U=M.choices[0].message.reasoning_content)),j?(Ie(d,j,!1,m,null,a,U),i(j,!0,U)):(Ie(d,"错误：API响应无效或内容为空。",!1,m,null,a),i(null,!0,null));case 18:e.n=20;break;case 19:e.p=19,"AbortError"===(R=e.v).name?(N=document.getElementById(a),q=(null==N||null===(H=N.querySelector(".message-text"))||void 0===H?void 0:H.innerText)||"",Ie(d,q+"\n[AI 回复已手动停止]",!1,m,null,a),q.trim()&&(de.push({role:"assistant",content:q+"\n[手动停止]",contextId:ge}),He())):(console.error("API Call Failed:",R),Ie(d,"连接 API 时出错：".concat(R.message),!1,m,null,a)),i(null,!0,null);case 20:return e.p=20,fe&&!fe.signal.aborted?(Ge(),T.style.display="none",fe=null):fe||(Ge(),T.style.display="none"),e.f(20);case 21:return e.a(2)}},t,null,[[3,5],[1,19,20,21]])}))).apply(this,arguments)}function Te(){return Oe.apply(this,arguments)}function Oe(){return(Oe=o(e().m(function t(){var n,r,o,a,i,c,s,l,u,d;return e().w(function(e){for(;;)switch(e.n){case 0:if(me.apiKey&&me.apiUrl){e.n=1;break}return Ae("请先填写 API 密钥和地址。","error"),e.a(2);case 1:return n=me.apiUrl.replace(/\/$/,""),r={"Content-Type":"application/json"},"gemini"===me.provider?n+="?key=".concat(me.apiKey):(n+="/models",r.Authorization="Bearer ".concat(me.apiKey)),Y.disabled=!0,Y.innerHTML='<i class="fas fa-spinner fa-spin mr-1"></i> 获取中...',e.p=2,e.n=3,fetch(n,{method:"GET",headers:r});case 3:if((o=e.v).ok){e.n=5;break}return e.n=4,o.json().catch(function(){return{error:{message:o.statusText}}});case 4:throw i=e.v,c=(null===(a=i.error)||void 0===a?void 0:a.message)||i.message||o.statusText,new Error("(".concat(o.status,"): ").concat(c));case 5:return e.n=6,o.json();case 6:s=e.v,l=[],"gemini"===me.provider?s.models&&Array.isArray(s.models)&&(l=s.models.filter(function(e){var t;return(null===(t=e.supportedGenerationMethods)||void 0===t?void 0:t.includes("generateContent"))&&e.name&&!e.name.includes("embedContent")&&!e.name.includes("aqa")}).map(function(e){return e.name.startsWith("models/")?e.name.substring(7):e.name}).sort(function(e,t){return e.includes("flash")&&!t.includes("flash")?-1:!e.includes("flash")&&t.includes("flash")?1:e.includes("pro")&&!t.includes("pro")?-1:!e.includes("pro")&&t.includes("pro")?1:e.localeCompare(t)})):s.data&&Array.isArray(s.data)?l=s.data.map(function(e){return e.id}).filter(Boolean).sort():Array.isArray(s)&&(l=s.map(function(e){return"string"==typeof e?e:e.id}).filter(Boolean).sort()),l.length>0?(me.models=l,V.value=l.join(","),Be(),me.defaultModel&&me.models.includes(me.defaultModel)||(u=me.models[0],"gemini"===me.provider?u=me.models.find(function(e){return e.includes("flash-latest")})||me.models.find(function(e){return e.includes("flash")})||me.models.find(function(e){return e.includes("pro-latest")})||me.models.find(function(e){return e.includes("pro")})||me.models[0]:"openai"===me.provider?u=me.models.find(function(e){return e.includes("gpt-3.5-turbo")})||me.models.find(function(e){return e.includes("gpt-4")})||me.models[0]:"deepseek"===me.provider&&(u=me.models.find(function(e){return e.includes("deepseek-chat")})||me.models[0]),me.defaultModel=u,W.value=me.defaultModel),Ae("模型列表已成功获取！","success")):Ae("未能获取到模型列表，请检查API配置或手动填写。","warning"),e.n=8;break;case 7:e.p=7,d=e.v,console.error("Fetch models error:",d),Ae("获取模型列表出错: ".concat(d.message),"error");case 8:return e.p=8,Y.disabled=!1,Y.innerHTML='<i class="fas fa-cloud-download-alt"></i> 自动获取模型',e.f(8);case 9:return e.a(2)}},t,null,[[2,7,8,9]])}))).apply(this,arguments)}function Pe(){var e=Office.context.host===Office.HostType.Excel?Office.CoercionType.Table:Office.CoercionType.Text;Office.context.document.getSelectedDataAsync(e,function(e){if(e.status===Office.AsyncResultStatus.Failed)Office.context.host===Office.HostType.Excel?Office.context.document.getSelectedDataAsync(Office.CoercionType.Text,function(e){e.status===Office.AsyncResultStatus.Succeeded?Me(e.value,!1):he("获取选中内容失败: ".concat(e.error.message),"error")}):he("获取选中内容失败: ".concat(e.error.message),"error");else{var t=void 0!==e.value.headers;Me(e.value,t)}})}function Me(e,t){var n="";if(t){var r=e.headers[0],o=e.rows,a="| ".concat(r.join(" | ")," |"),i="|".concat(r.map(function(){return"---"}).join("|"),"|"),c=o.map(function(e){return"| ".concat(e.join(" | ")," |")}).join("\n");n="".concat(a,"\n").concat(i,"\n").concat(c)}else n=String(e);if(n.trim()){var s=E.value;E.value=s?"".concat(s,"\n\n---\n引用内容:\n").concat(n):n,E.focus(),$e(),D.disabled=!1,he("已获取选中内容","success")}else he("未选中任何内容或内容为空","warning")}function je(e){Office.context.document.setSelectedDataAsync(e,{coercionType:Office.CoercionType.Text},function(e){e.status===Office.AsyncResultStatus.Failed?he("插入失败: ".concat(e.error.message),"error"):he("内容已插入","success")})}function Ue(){fe&&(fe.abort(),he("已停止 AI 回复","info"))}function He(){try{var e=JSON.parse(localStorage.getItem(v))||{};e[ge]={u:le,aC:ue,t:Date.now(),m:de},localStorage.setItem(v,JSON.stringify(e))}catch(e){console.error(e)}}function Ne(){var e,t;he('确定要清空当前聊天记录吗？此操作无法撤销。<br><div class="mt-3 flex gap-2 justify-end"><button id="confirmClear" class="btn !bg-[var(--error-color)] !text-white !text-xs !py-1 !px-3">确认清空</button><button id="cancelClear" class="btn btn-secondary !text-xs !py-1 !px-3">取消</button></div>',"warning",1e4),null===(e=document.getElementById("confirmClear"))||void 0===e||e.addEventListener("click",function(){de=[],b.innerHTML='<div class="text-center my-3"><span class="text-xs px-3 py-1.5 rounded-full bg-[var(--bg-accent)] text-[var(--text-secondary)] shadow-sm glassmorphism border-none">聊天记录已清空</span></div>';var e=JSON.parse(localStorage.getItem(v))||{};e[ge]&&(delete e[ge],localStorage.setItem(v,JSON.stringify(e))),he("聊天记录已清空","info",2e3),u&&clearTimeout(u),ce.style.opacity="0"}),null===(t=document.getElementById("cancelClear"))||void 0===t||t.addEventListener("click",function(){u&&clearTimeout(u),ce.style.opacity="0"})}function qe(){ge=Date.now().toString(),de=[],b.innerHTML='<div class="text-center my-3"><span class="text-xs px-3 py-1.5 rounded-full bg-[var(--bg-accent)] text-[var(--text-secondary)] shadow-sm glassmorphism border-none">新对话已开始 (上下文已重置)</span></div>',he("新对话已开始 (上下文已重置)","info",2500)}function Re(){x.innerHTML="";var e=document.documentElement.classList.contains("light"),t=e?"3b82f6":"6a82fb",n=e?"ffffff":"e0e7ff",r=e?"10b981":"2dd4bf",o=e?"ffffff":"0d0f1a";x.appendChild(_e(le,ue,"online",!1,t,n)),x.appendChild(_e(d,m,"online",!0,r,o))}function _e(e,t,n,r,o,a){var i=document.createElement("li");i.className="user-list-item flex items-center p-2.5 rounded-lg hover:bg-[var(--bg-accent)] transition duration-150 cursor-pointer group",i.dataset.username=e,i.dataset.isBot=r;var c=document.createElement("img");c.src=ve(t,"40x40",o,a),c.alt=e,c.className="w-9 h-9 rounded-full mr-3 flex-shrink-0 shadow-sm";var s=document.createElement("span");s.className="text-sm font-medium text-[var(--text-primary)] truncate group-hover:text-[var(--text-accent)]",s.textContent=e;var l=document.createElement("span");return l.className="ml-auto w-2.5 h-2.5 rounded-full flex-shrink-0 border-2 border-[var(--bg-secondary)] ".concat("online"===n?r?"bg-sky-400":"bg-green-400 animate-pulseGlow":"bg-gray-400"),r&&"online"===n?l.style.setProperty("--shadow-glow","rgba(56,189,248,0.5)"):r||"online"!==n||l.style.setProperty("--shadow-glow","rgba(74,222,128,0.5)"),i.appendChild(c),i.appendChild(s),i.appendChild(l),i.style.cursor="default",i}function Ge(){L.innerHTML=""}function Ke(e){(void 0!==e?e:F.classList.contains("hidden"))?(F.classList.remove("hidden"),pe=!0,setTimeout(function(){return document.addEventListener("click",Je,!0)},0)):(F.classList.add("hidden"),pe=!1,document.removeEventListener("click",Je,!0))}function Je(e){F.contains(e.target)||e.target===I||I.contains(e.target)||Ke(!1)}function $e(){E.style.height="auto";var e=Math.max(50,Math.min(E.scrollHeight+2,180));E.style.height="".concat(e,"px")}function ze(){ie.innerHTML="",me.customBodyParams&&0!==me.customBodyParams.length?me.customBodyParams.forEach(function(e,t){var n=document.createElement("div");n.className="custom-body-param-item flex items-center gap-2 p-2 bg-[var(--bg-accent)] border border-[var(--border-accent)] rounded-md animate-fadeIn",n.innerHTML='<span class="key font-mono text-xs text-[var(--text-accent)]">'.concat(e.key,':</span><span class="value flex-grow font-mono text-xs text-[var(--text-secondary)] overflow-hidden text-ellipsis whitespace-nowrap" title="').concat(e.value,'">').concat(e.value,'</span><button type="button" class="btn-remove-param btn !p-1 !text-xs !bg-transparent !text-[var(--error-color)] hover:!bg-[var(--error-color)] hover:!text-white" data-index="').concat(t,'" title="移除"><i class="fas fa-times"></i></button>'),n.querySelector(".btn-remove-param").addEventListener("click",function(e){return function(e){var t;if(null!==(t=me.customBodyParams)&&void 0!==t&&t[e]){var n=me.customBodyParams.splice(e,1)[0];ze(),ke(),Ae('参数 "'.concat(n.key,'" 已移除。'),"info")}}(parseInt(e.currentTarget.dataset.index))}),ie.appendChild(n)}):ie.innerHTML='<p class="text-xs text-[var(--text-secondary)] italic">尚无自定义参数。</p>'}function Ve(){var e=re.value.trim(),t=oe.value.trim();if(!e)return Ae("参数名 (Key) 不能为空。","error"),void re.focus();if(!t)return Ae("参数值 (Value) 不能为空。","error"),void oe.focus();try{JSON.parse(t)}catch(e){if(!confirm("参数值不是有效的JSON。字符串需要用引号包裹。要作为普通字符串添加吗？"))return Ae("操作已取消。","info"),void oe.focus()}Array.isArray(me.customBodyParams)||(me.customBodyParams=[]),me.customBodyParams.push({key:e,value:t}),ze(),ke(),re.value="",oe.value="",Ae('参数 "'.concat(e,'" 已添加。'),"success")}}(),function(){"use strict";new URL(n(58394),n.b),new URL(n(60947),n.b)}()}();
//# sourceMappingURL=taskpane.js.map